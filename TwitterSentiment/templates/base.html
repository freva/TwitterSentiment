{% load staticfiles %}

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Animated Symbols</title>

	<link rel="stylesheet" type="text/css" href="{% static 'styles/reset.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'styles/main.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'styles/token-input.css' %}" />
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{% static 'js/raphael-2.1.0.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/kartograph.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/chroma.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'django_ajax/js/jquery.ajax.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.tokeninput.js' %}"></script>
</head>
<body>

<div class="container">
	<div id="sidebar">
		<h1>Tittel</h1>
		<form id="search-form">
         {% csrf_token %}
   		<input type="text" name="search" id="search-field">
   		<input type="submit" value="Search" id="search-button">
      </form>
	</div>
	
	<script type="text/javascript">
    var scale, symbols, map, maxRad = 30;

    $(function() {
        map = window.m = kartograph.map('#map');
        map.loadMap("{% static 'display/map-usa.svg' %}", function() {
            map.addLayer('usa', {
                styles: {
                    fill: '#dfdcdc',
                    stroke: '#fff'
                }
            });
        });
    });

    $(document).ready(function() {
        $("#search-field").tokenInput( {{ tags|safe }}, {
            method: 'POST',
            hintText: "#hashtag",
            resultsLimit: 10,
            preventDuplicates: true,
            onAdd: function (results) { searchTweets($('#search-field').val()); },
            onDelete: function (results) { searchTweets($('#search-field').val()); }

        });
    });

    function searchTweets(term) {
        if (term.length == 0) {
            if (symbols) symbols.remove();
            return;
        }

         ajaxPost('/get_hashtag/', {'hashtag':term}, function(response) {
            crimeCities = response.results;
            scale = kartograph.scale.log(crimeCities, "count");

            if (symbols) symbols.remove();
            symbols = map.addSymbols({
                type: kartograph.PieChart,
                data: crimeCities,
                colors: ['#fc575e', '#ffff00', '#7ca668'],
                border: "#fff",
                location: function(d) { return [d.lng, d.lat] },
                values: function(d) { return d.polarity; },
                radius: function(d) { return 3+scale(d.count)*maxRad; },
                titles: function(d) {
                    var desc = [];
                    for(var i=0; i<d.polarity.length; i++) desc.push(d.polarity[i] + " out of " + d.count);
                    return desc;
                }
            });
            console.log(symbols);
         });
    }

    $(function() { $( document ).tooltip(); });
    </script>

	<div style="position:relative">
		<div id="map"></div>
	</div>
</div>

</body>
</html>